{% extends "site_base.html" %}

{% load i18n static compress %}

{% block head_title %}Kunnallisvaaliehdokkaiden ennakkorahoitusilmoitukset{% endblock %}

{% block extra_style %}
	<link rel="stylesheet" href="{% static "css/leaflet.css" %}" />
	
	<style>
		#map {
			width: 500px;
			height: 650px;
		}

		.info {
			padding: 6px 8px;
			font: 14px/16px Arial, Helvetica, sans-serif;
			background: white;
			background: rgba(255,255,255,0.8);
			box-shadow: 0 0 15px rgba(0,0,0,0.2);
			border-radius: 5px;
		}
		.info h4 {
			margin: 0 0 5px;
			color: #777;
		}

		.legend {
			text-align: left;
			line-height: 18px;
			color: #555;
		}
		.legend i {
			width: 18px;
			height: 18px;
			float: left;
			margin-right: 8px;
			opacity: 0.7;
		}
	</style>
{% endblock %}

{% block extra_script %}
{% compress js %}
<script type="text/javascript" src="{% static "js/underscore.js" %}"></script>
<script type="text/javascript" src="{% static "js/leaflet.js" %}"></script>
{% endcompress %}

{% compress js %}
<script type="text/coffeescript">
muni_dict = {{ muni_json|safe }}
party_list = {{ party_json|safe }}

$.ajax '/api/v1/municipality/'
  dataType: 'json'
  data:
    limit: 1000
    format: 'geojson'
  error: (args1, args2) ->
    alert "{% trans "Communication with server failed" %}"
  success: (geojson) ->
    console.log geojson
    for feat in geojson.features
      muni = muni_dict[feat.id]
      # If the muni is not found, it doesn't have the stats.
      # We don't render those.
      if not muni
        feat.properties.render = false
      else
        _.extend(feat.properties, muni)
      console.log feat.properties
    # geojson is now ready to be passed to leaflet
	

# The code below is run after the HTML document has finished loading.
jQuery ->
  console.log "here"

</script>
{% endcompress %}

{% compress js %}

<!--<script type="text/javascript" src="http://109.74.199.6:8080/datavaalit/muni_stats.js"></script>-->
<script type="text/javascript">

	var southWest = new L.LatLng(61.5, 23.00),
        northEast = new L.LatLng(68.50, 29.00),
        bounds = new L.LatLngBounds(southWest, northEast);
	var map = L.map('map', {
		minZoom: 5,
		maxZoom: 7, 
        // Some basic options to keep the map still and prevent 
        // the user from zooming and such.
        scrollWheelZoom: true,
        touchZoom: true,
        doubleClickZoom: true,
        zoomControl: true,
        dragging: true
    }).fitBounds(bounds);

	var cloudmade = L.tileLayer('http://{s}.tile.cloudmade.com/{key}/{styleId}/256/{z}/{x}/{y}.png', {
		attribution: 'Map data &copy; 2011 OpenStreetMap contributors, Imagery &copy; 2011 CloudMade',
		key: 'BC9A493B41014CAABB98F0471D759707',
		styleId: 22677
	}).addTo(map);


	// control that shows state info on hover
	var info = L.control();

	info.onAdd = function (map) {
		this._div = L.DomUtil.create('div', 'info');
		this.update();
		return this._div;
	};

	info.update = function (props) {
		this._div.innerHTML = '<h4>Vaalirahoituksen ennakkoilmoituksen</h4><h4>tehneiden ehdokkaiden osuus</h4>' +  (props ?
			'<b>' + props.name + '</b> (' + props.ncandidates + ' ehdokasta)' + '<br />' + (props.prebudg_perc * 100).toFixed(0) + ' % tehnyt ennakkoilmoituksen'
			: 'Vie osoitin kunnan päälle');
	};

	info.addTo(map);


	// get color depending on population density value
	function getColor(d) {
        return d > 0.40  ? '#1A9850' :
        	   d > 0.30  ? '#91CF60' :		
               d > 0.20  ? '#D9EF8B' :
               d > 0.10  ? '#FEE08B' :
               d > 0.01  ? '#FC8D59' :
                           '#D73027';
    } 

	function style(feature) {
        return {
            fillColor: getColor(feature.properties.prebudg_perc),
            weight: 1,
            color: '#666',
            opacity: 0.6,
            fillOpacity: 1.0
        };
    }

	function highlightFeature(e) {
		var layer = e.target;

		layer.setStyle({
			weight: 5,
			color: '#666',
			dashArray: '',
			fillOpacity: 0.7
		});

		if (!L.Browser.ie && !L.Browser.opera) {
			layer.bringToFront();
		}

		info.update(layer.feature.properties);
	}

	var geojson;

	function resetHighlight(e) {
		geojson.resetStyle(e.target);
		info.update();
	}

	function zoomToFeature(e) {
		map.fitBounds(e.target.getBounds());
	}

	function onEachFeature(feature, layer) {
		layer.on({
			mouseover: highlightFeature,
			mouseout: resetHighlight,
			click: zoomToFeature
		});
	}

	geojson = L.geoJson(geojson, {
		style: style,
		onEachFeature: onEachFeature
	}).addTo(map);

	//map.attributionControl.addAttribution('Population data &copy; <a href="http://census.gov/">US Census Bureau</a>');


	var legend = L.control({position: 'bottomright'});

	legend.onAdd = function (map) {

		var div = L.DomUtil.create('div', 'info legend'),
			grades = [0.0, 0.01, 0.10, 0.20, 0.30, 0.40],
			labels = [],
			from, from_pr, to, to_pr;

		for (var i = 0; i < grades.length; i++) {
			from = grades[i];
			from_pr = (from * 100).toFixed(0)
			to = grades[i + 1];
			to_pr = (to * 100).toFixed(0)

			labels.push(
				'<i style="background:' + getColor(from + 0.01) + '"></i> ' +
				from_pr + ' % ' + (to ? ' &ndash; ' + to_pr + ' % ' : '+'));
		}

		div.innerHTML = labels.join('<br>');
		return div;
	};

	legend.addTo(map);

</script>

{% endcompress %}

{% endblock %}

{% block body %}
  <h1 style="font-size: 26px;">Kunnallisvaaliehdokkaiden 2012 ennakkorahoitusilmoitukset</h1>
  
  <div id="map"></div>
  
{% endblock %}

